---

- name: Create "OS upgraded" lock file # run only once
  become: true
  ansible.builtin.copy:
    dest: /etc/apt/os-upgraded.lock
    content: 'ansible'
    mode: 0640
    owner: root
    group: root
    force: false
  register: _os_need_to_be_upgraded

- name: Upgrade OS # noqa no-handler
  become: true
  ansible.builtin.apt: {upgrade: dist, update_cache: true}
  when: _os_need_to_be_upgraded.changed

- name: Reboot the machine # noqa no-handler
  become: true
  ansible.builtin.reboot: {post_reboot_delay: 10}
  when: _os_need_to_be_upgraded.changed
